#!/bin/bash

# -----------------------------------------------
# Script for Sending Email with Compression Status
# -----------------------------------------------

# Fetch Reporting Dates and Statuses from Database
REPORTING_DATES=$(sqlplus -s $REG_LOGIN <<EOF
SET PAGESIZE 0
SET TRIM ON
SET HEAD OFF
SET FEEDBACK OFF
SET LINESIZE 1000
SET ECHO OFF
WHENEVER SQLERROR EXIT 1

SELECT TO_CHAR(REPORTING_DATE, 'DD-MM-YYYY') || ',' || 'COMPLETED'
FROM BOE_AXIOM_DATA.COMPRESSION_SCHEDULING_CAL
WHERE COMPRESSION_FLAG = 'Y' AND MAIL_FLAG = 'N'
ORDER BY REPORTING_DATE;

EXIT;
EOF
)

# Clean up the output to remove empty lines
REPORTING_DATES=$(echo "$REPORTING_DATES" | sed '/^$/d')

# Check if any reporting dates are available
if [ -z "$REPORTING_DATES" ]; then
    echo "No Reporting Periods Found for Sending Email."
    exit 0
fi

# -----------------------------------------------
# Generate HTML Table Content Dynamically
# -----------------------------------------------
TABLE_CONTENT=""
while IFS= read -r LINE; do
    DATE=$(echo "$LINE" | awk -F',' '{print $1}')  # Extract Reporting Date
    STATUS=$(echo "$LINE" | awk -F',' '{print $2}') # Extract Compression Status
    TABLE_CONTENT+="<tr><td style='border: 1px solid black; padding: 5px;'>$DATE</td><td style='border: 1px solid black; padding: 5px;'>$STATUS</td></tr>"
done <<< "$REPORTING_DATES"

# -----------------------------------------------
# Prepare HTML Email Content
# -----------------------------------------------
EMAIL_CONTENT=$(cat <<EOF
<html>
<head>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            text-align: left;
            padding: 8px;
        }
        th {
            background-color: #00AEEF; /* Barclays blue */
            color: white;
        }
        .barclays-classification {
            text-align: center;
            font-size: 9px;
            font-weight: bold;
            color: #00AEEF; /* Barclays blue */
        }
    </style>
</head>
<body>
    <p>Hi All,</p>
    <p>The compression process has been successfully completed for the following reporting periods:</p>
    <table style="border: 1px solid black; border-collapse: collapse; width: 100%;">
        <tr>
            <th style="border: 1px solid black; padding: 5px;">Reporting Date</th>
            <th style="border: 1px solid black; padding: 5px;">Compression Status</th>
        </tr>
        $TABLE_CONTENT
    </table>
    <p class="barclays-classification">barclays classification: restricted - internal</p>
</body>
</html>
EOF
)

# Debugging: Print the email content to verify formatting
echo "DEBUG: Email Content Generated:"
echo "$EMAIL_CONTENT"

# -----------------------------------------------
# Send the Email with HTML Content
# -----------------------------------------------
echo "$EMAIL_CONTENT" | mailx -a "Content-Type: text/html" -s "COMPRESSION OF AXIOM TABLES" $MAIL_PURG_NOTIFICATION_ID

# Check if the email was sent successfully
if [ $? -eq 0 ]; then
    echo "Email sent successfully."

    # -----------------------------------------------
    # Update MAIL_FLAG for Processed Reporting Dates
    # -----------------------------------------------
    sqlplus -s $REG_LOGIN <<EOF
SET ECHO OFF
WHENEVER SQLERROR EXIT 1

UPDATE BOE_AXIOM_DATA.COMPRESSION_SCHEDULING_CAL
SET MAIL_FLAG = 'Y'
WHERE COMPRESSION_FLAG = 'Y' AND MAIL_FLAG = 'N';
COMMIT;
EXIT;
EOF
    echo "Mail Flag Updated to 'Y' for All Processed Reporting Dates."
else
    echo "Failed to send email."
fi
